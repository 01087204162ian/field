<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë³´í—˜ CMS - ëŒ€ì‹œë³´ë“œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            color: #2d3748;
            line-height: 1.6;
        }

        /* í—¤ë” ìŠ¤íƒ€ì¼ */
        .header {
            background: white;
            border-bottom: 1px solid #e2e8f0;
            padding: 0 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            height: 70px;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-name {
            font-weight: 600;
            color: #2d3748;
        }

        .user-role {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .logout-btn {
            background: #e53e3e;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: #c53030;
            transform: translateY(-1px);
        }

        /* ë©”ì¸ ì»¨í…Œì´ë„ˆ */
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .page-title {
            font-size: 32px;
            font-weight: 300;
            margin-bottom: 30px;
            color: #2d3748;
        }

        /* ì¶œí‡´ê·¼ ì¹´ë“œ */
        .attendance-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .attendance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .attendance-title {
            font-size: 24px;
            font-weight: 600;
        }

        .current-time {
            font-size: 18px;
            opacity: 0.9;
        }

        .attendance-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .attendance-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px 30px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .attendance-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
        }

        .attendance-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .attendance-status {
            display: flex;
            gap: 30px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .status-item {
            text-align: center;
        }

        .status-label {
            font-size: 14px;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .status-value {
            font-size: 20px;
            font-weight: 600;
        }

        /* ëŒ€ì‹œë³´ë“œ ê·¸ë¦¬ë“œ */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .dashboard-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #2d3748;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-icon {
            width: 24px;
            height: 24px;
            background: #667eea;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
        }

        .stat-number {
            font-size: 36px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #718096;
            font-size: 14px;
        }

        /* ê´€ë¦¬ì ì „ìš© ì„¹ì…˜ */
        .admin-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
        }

        .admin-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2d3748;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .admin-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .admin-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
        }

        .admin-btn:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }

        /* ì•Œë¦¼ ìŠ¤íƒ€ì¼ */
        .notification {
            background: #e6fffa;
            border: 1px solid #81e6d9;
            color: #234e52;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .notification.show {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        .notification.error {
            background: #fed7d7;
            border-color: #feb2b2;
            color: #742a2a;
        }

        .notification.success {
            background: #c6f6d5;
            border-color: #9ae6b4;
            color: #22543d;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ëª¨ë°”ì¼ ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .main-container {
                padding: 20px 15px;
            }

            .page-title {
                font-size: 24px;
            }

            .attendance-card {
                padding: 20px;
            }

            .attendance-title {
                font-size: 20px;
            }

            .current-time {
                font-size: 16px;
            }

            .attendance-buttons {
                justify-content: center;
            }

            .attendance-btn {
                padding: 10px 20px;
                font-size: 14px;
            }

            .attendance-status {
                justify-content: center;
                gap: 20px;
            }

            .header-content {
                padding: 0 10px;
            }

            .user-info {
                gap: 10px;
            }

            .admin-actions {
                justify-content: center;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .attendance-status {
                flex-direction: column;
                gap: 15px;
            }

            .status-item {
                padding: 10px;
                background: rgba(255, 255, 255, 0.1);
                border-radius: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- í—¤ë” -->
    <header class="header">
        <div class="header-content">
            <div class="logo">ë³´í—˜ CMS</div>
            <div class="user-info">
                <span class="user-name" id="userName">ì‚¬ìš©ì</span>
                <span class="user-role" id="userRole">ì§ì›</span>
                <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>
    </header>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <main class="main-container">
        <h1 class="page-title">ëŒ€ì‹œë³´ë“œ</h1>

        <!-- ì•Œë¦¼ ì˜ì—­ -->
        <div id="notification" class="notification"></div>

        <!-- ì¶œí‡´ê·¼ ì¹´ë“œ -->
        <div class="attendance-card">
            <div class="attendance-header">
                <h2 class="attendance-title">ì¶œí‡´ê·¼ ê´€ë¦¬</h2>
                <div class="current-time" id="currentTime"></div>
            </div>

            <div class="attendance-buttons">
                <button class="attendance-btn" id="checkinBtn" onclick="checkIn()">
                    ì¶œê·¼í•˜ê¸°
                </button>
                <button class="attendance-btn" id="checkoutBtn" onclick="checkOut()" disabled>
                    í‡´ê·¼í•˜ê¸°
                </button>
            </div>

            <div class="attendance-status">
                <div class="status-item">
                    <div class="status-label">ì¶œê·¼ì‹œê°„</div>
                    <div class="status-value" id="checkinTime">--:--</div>
                </div>
                <div class="status-item">
                    <div class="status-label">í‡´ê·¼ì‹œê°„</div>
                    <div class="status-value" id="checkoutTime">--:--</div>
                </div>
                <div class="status-item">
                    <div class="status-label">ê·¼ë¬´ì‹œê°„</div>
                    <div class="status-value" id="workHours">0.0h</div>
                </div>
            </div>
        </div>

        <!-- ëŒ€ì‹œë³´ë“œ ì¹´ë“œë“¤ -->
        <div class="dashboard-grid">
            <div class="dashboard-card">
                <h3 class="card-title">
                    <span class="card-icon">ğŸ“Š</span>
                    ì´ë²ˆ ë‹¬ ì‹¤ì 
                </h3>
                <div class="stat-number" id="monthlyStats">-</div>
                <div class="stat-label">ì²˜ë¦¬ ê±´ìˆ˜</div>
            </div>

            <div class="dashboard-card">
                <h3 class="card-title">
                    <span class="card-icon">â±ï¸</span>
                    í‰ê·  ì²˜ë¦¬ì‹œê°„
                </h3>
                <div class="stat-number" id="avgProcessingTime">-</div>
                <div class="stat-label">ë¶„</div>
            </div>

            <div class="dashboard-card">
                <h3 class="card-title">
                    <span class="card-icon">ğŸ“…</span>
                    ì´ë²ˆ ì£¼ ê·¼ë¬´
                </h3>
                <div class="stat-number" id="weeklyHours">-</div>
                <div class="stat-label">ì‹œê°„</div>
            </div>

            <div class="dashboard-card">
                <h3 class="card-title">
                    <span class="card-icon">ğŸ¯</span>
                    ëª©í‘œ ë‹¬ì„±ë¥ 
                </h3>
                <div class="stat-number" id="achievementRate">-</div>
                <div class="stat-label">%</div>
            </div>
        </div>

        <!-- ê´€ë¦¬ì ì „ìš© ì„¹ì…˜ -->
        <div class="admin-section" id="adminSection" style="display: none;">
            <h2 class="admin-title">
                <span class="card-icon">âš™ï¸</span>
                ê´€ë¦¬ì ë©”ë‰´
            </h2>
            <div class="admin-actions">
                <a href="/register.html" class="admin-btn">ì§ì› ë“±ë¡</a>
                <button class="admin-btn" onclick="viewAllEmployees()">ì§ì› ê´€ë¦¬</button>
                <button class="admin-btn" onclick="viewReports()">ë¦¬í¬íŠ¸</button>
                <button class="admin-btn" onclick="systemSettings()">ì‹œìŠ¤í…œ ì„¤ì •</button>
            </div>
        </div>
    </main>

    <script>
        class Dashboard {
            constructor() {
                this.user = null;
                this.attendanceData = null;
                
                this.initialize();
            }

            async initialize() {
                await this.checkAuth();
                this.updateCurrentTime();
                this.loadDashboardData();
                
                // 1ë¶„ë§ˆë‹¤ ì‹œê°„ ì—…ë°ì´íŠ¸
                setInterval(() => this.updateCurrentTime(), 60000);
            }

            async checkAuth() {
                try {
                    const response = await fetch('/api/me', {
                        credentials: 'include'
                    });

                    if (!response.ok) {
                        window.location.href = '/login.html';
                        return;
                    }

                    const data = await response.json();
                    this.user = data.user;
                    this.updateUserInfo();

                } catch (error) {
                    console.error('ì¸ì¦ í™•ì¸ ì˜¤ë¥˜:', error);
                    window.location.href = '/login.html';
                }
            }

            updateUserInfo() {
                document.getElementById('userName').textContent = this.user.name;
                
                const roleNames = {
                    'admin': 'ìµœê³ ê´€ë¦¬ì',
                    'dept_manager': 'ë¶€ì„œê´€ë¦¬ì', 
                    'sys_admin': 'ì‹œìŠ¤í…œê´€ë¦¬ì',
                    'employee': 'ì¼ë°˜ì§ì›'
                };
                
                document.getElementById('userRole').textContent = roleNames[this.user.role] || 'ì§ì›';

                // ê´€ë¦¬ì ì„¹ì…˜ í‘œì‹œ
                if (['admin', 'dept_manager', 'sys_admin'].includes(this.user.role)) {
                    document.getElementById('adminSection').style.display = 'block';
                }
            }

            updateCurrentTime() {
                const now = new Date();
                const timeString = now.toLocaleTimeString('ko-KR', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                document.getElementById('currentTime').textContent = timeString;
            }

            async loadDashboardData() {
                try {
                    const response = await fetch('/api/dashboard', {
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.updateAttendanceStatus(data.data.todayAttendance);
                        this.updateStats(data.data);
                    }

                } catch (error) {
                    console.error('ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                }
            }

            updateAttendanceStatus(attendance) {
                this.attendanceData = attendance;

                const checkinBtn = document.getElementById('checkinBtn');
                const checkoutBtn = document.getElementById('checkoutBtn');
                const checkinTime = document.getElementById('checkinTime');
                const checkoutTime = document.getElementById('checkoutTime');
                const workHours = document.getElementById('workHours');

                if (attendance) {
                    if (attendance.check_in_time) {
                        checkinTime.textContent = attendance.check_in_time;
                        checkinBtn.disabled = true;
                        checkinBtn.textContent = 'ì¶œê·¼ì™„ë£Œ';
                        checkoutBtn.disabled = false;
                    }

                    if (attendance.check_out_time) {
                        checkoutTime.textContent = attendance.check_out_time;
                        checkoutBtn.disabled = true;
                        checkoutBtn.textContent = 'í‡´ê·¼ì™„ë£Œ';
                    }

                    if (attendance.work_hours) {
                        workHours.textContent = attendance.work_hours + 'h';
                    }
                } else {
                    // ì˜¤ëŠ˜ ì¶œê·¼ ê¸°ë¡ì´ ì—†ëŠ” ê²½ìš°
                    checkinBtn.disabled = false;
                    checkoutBtn.disabled = true;
                }
            }

            updateStats(data) {
                // ì‹¤ì œ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸, ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ í‘œì‹œ
                document.getElementById('monthlyStats').textContent = data.monthlyStats || '0';
                document.getElementById('avgProcessingTime').textContent = data.avgProcessingTime || '0';
                document.getElementById('weeklyHours').textContent = data.weeklyHours || '0';
                document.getElementById('achievementRate').textContent = data.achievementRate || '0';
            }

            showNotification(message, type = 'success') {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.className = `notification ${type} show`;

                setTimeout(() => {
                    notification.classList.remove('show');
                }, 5000);
            }
        }

        // ì „ì—­ í•¨ìˆ˜ë“¤
        async function checkIn() {
            const btn = document.getElementById('checkinBtn');
            const originalText = btn.textContent;
            
            btn.innerHTML = '<span class="loading"></span> ì²˜ë¦¬ì¤‘...';
            btn.disabled = true;

            try {
                const response = await fetch('/api/attendance/checkin', {
                    method: 'POST',
                    credentials: 'include'
                });

                const data = await response.json();

                if (data.success) {
                    dashboard.showNotification(data.message, 'success');
                    
                    // UI ì—…ë°ì´íŠ¸
                    document.getElementById('checkinTime').textContent = data.checkInTime;
                    btn.textContent = 'ì¶œê·¼ì™„ë£Œ';
                    document.getElementById('checkoutBtn').disabled = false;
                } else {
                    dashboard.showNotification(data.message, 'error');
                    btn.textContent = originalText;
                    btn.disabled = false;
                }

            } catch (error) {
                console.error('ì¶œê·¼ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                dashboard.showNotification('ì¶œê·¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        async function checkOut() {
            const btn = document.getElementById('checkoutBtn');
            const originalText = btn.textContent;
            
            btn.innerHTML = '<span class="loading"></span> ì²˜ë¦¬ì¤‘...';
            btn.disabled = true;

            try {
                const response = await fetch('/api/attendance/checkout', {
                    method: 'POST',
                    credentials: 'include'
                });

                const data = await response.json();

                if (data.success) {
                    dashboard.showNotification(data.message, 'success');
                    
                    // UI ì—…ë°ì´íŠ¸
                    document.getElementById('checkoutTime').textContent = data.checkOutTime;
                    document.getElementById('workHours').textContent = data.workHours + 'h';
                    btn.textContent = 'í‡´ê·¼ì™„ë£Œ';
                } else {
                    dashboard.showNotification(data.message, 'error');
                    btn.textContent = originalText;
                    btn.disabled = false;
                }

            } catch (error) {
                console.error('í‡´ê·¼ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                dashboard.showNotification('í‡´ê·¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        async function logout() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                try {
                    const response = await fetch('/api/logout', {
                        method: 'POST',
                        credentials: 'include'
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        window.location.href = '/login.html';
                    } else {
                        alert('ë¡œê·¸ì•„ì›ƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    }

                } catch (error) {
                    console.error('ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:', error);
                    alert('ë¡œê·¸ì•„ì›ƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }
        }

        // ê´€ë¦¬ì ê¸°ëŠ¥ë“¤ (ì¶”í›„ êµ¬í˜„)
        function viewAllEmployees() {
            dashboard.showNotification('ì§ì› ê´€ë¦¬ í˜ì´ì§€ëŠ” ê°œë°œ ì¤‘ì…ë‹ˆë‹¤.', 'info');
        }

        function viewReports() {
            dashboard.showNotification('ë¦¬í¬íŠ¸ í˜ì´ì§€ëŠ” ê°œë°œ ì¤‘ì…ë‹ˆë‹¤.', 'info');
        }

        function systemSettings() {
            dashboard.showNotification('ì‹œìŠ¤í…œ ì„¤ì • í˜ì´ì§€ëŠ” ê°œë°œ ì¤‘ì…ë‹ˆë‹¤.', 'info');
        }

        // ëŒ€ì‹œë³´ë“œ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
        let dashboard;
        
        document.addEventListener('DOMContentLoaded', () => {
            dashboard = new Dashboard();
        });
    </script>
</body>
</html>